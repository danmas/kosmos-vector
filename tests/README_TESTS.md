# Тестирование проекта Aian-Vector

В проекте `aian-vector` используется несколько уровней тестирования для проверки корректной работы нового сервера `server-v2` и ядра `packages/core`.

## 1. API Smoke Test (`server-v2/api_test.js`)

Этот скрипт выполняет базовую проверку ("smoke test") доступности и работоспособности основных `GET` эндпоинтов сервера.

### Что проверяет:
-   **Доступность сервера**: Отправляет запрос на несуществующий роут и ожидает получить ответ `404 Not Found`.
-   **Получение списка файлов**: Проверяет эндпоинт `GET /files`, ожидает ответ `200 OK` и список файлов.
-   **Получение кодов контекста**: Проверяет `GET /context-codes`.
-   **Работоспособность RAG**: Отправляет запрос `POST /ask` и проверяет, что сервер отвечает, даже если контекст не найден.

### Как запустить:
1.  Убедитесь, что сервер `server-v2` запущен.
    ```bash
    node server-v2/index.js
    ```
2.  В отдельном терминале выполните команду:
    ```bash
    node server-v2/api_test.js
    ```

## 2. End-to-End (E2E) Full Cycle Test (`server-v2/full_cycle_test.js`)

Это комплексный тест, который проверяет весь жизненный цикл обработки одного файла: от векторизации до получения ответа от RAG и последующей очистки.

### Что проверяет:
-   **Полный CRUD-цикл для документов**:
    1.  **Удаление (Cleanup)**: Перед тестом отправляется `DELETE /file/:filename`, чтобы гарантировать отсутствие тестового файла в базе.
    2.  **Создание (Vectorization)**: Тестовый файл `server-v2/test_data/test_file.js` векторизуется через эндпоинт `POST /vectorize`. Тест проверяет, что API возвращает успешный статус и ненулевое количество созданных чанков.
    3.  **Чтение (Verification)**: Скрипт запрашивает чанки для созданного файла через `GET /file-chunks/:filename` и убеждается, что они появились в базе данных.
    4.  **Удаление (Final Cleanup)**: После всех проверок тестовый файл и все его чанки удаляются из базы данных через `DELETE /file/:filename`.
-   **Работоспособность RAG с реальным контекстом**:
    -   Тест задает конкретный вопрос, ответ на который содержится в `test_file.js`.
    -   Проверяется, что ответ от `POST /ask` содержит в себе фрагменты кода/текста из найденных чанков, а не ответ по умолчанию "информация не найдена". Это подтверждает, что вся цепочка (поиск -> ретривер -> модель) работает корректно.

### Как запустить:
1.  Убедитесь, что сервер `server-v2` запущен.
    ```bash
    node server-v2/index.js
    ```
2.  В отдельном терминале выполните команду:
    ```bash
    node server-v2/full_cycle_test.js
    ```

## 3. End-to-End (E2E) Folder Scan Test (`server-v2/folder_cycle_test.js`)

Этот тест проверяет весь конвейер для функциональности "Сканировать папку". Он эмулирует пакетную обработку нескольких файлов, расположенных в специальной тестовой директории.

### Что проверяет:
-   **Пакетная обработка**:
    1.  **Подготовка**: Создана тестовая папка `server-v2/test_data/test_folder` с несколькими файлами (`.js`, `.md`).
    2.  **Предварительная очистка**: Перед тестом скрипт удаляет все документы, связанные с тестовыми файлами, чтобы обеспечить чистоту эксперимента.
    3.  **Запуск сканирования**: Вызывается эндпоинт `POST /scan-and-vectorize` с путем к тестовой папке. Тест проверяет, что API возвращает успешный статус.
    4.  **Проверка (Verification)**: Для каждого файла из тестовой папки скрипт отправляет запрос `GET /file-chunks/:filename` и убеждается, что для всех файлов были созданы и сохранены чанки в базе данных.
-   **Работоспособность RAG с контекстом из нескольких файлов**:
    -   Тест задает конкретные вопросы, ответы на которые содержатся в разных файлах тестовой папки.
    -   Проверяется, что RAG находит правильный контекст для каждого вопроса и отвечает на основе содержимого соответствующего файла.
-   **Финальная очистка**: После всех проверок тестовые файлы и все их чанки удаляются из базы данных.

### Как запустить:
1.  Убедитесь, что сервер `server-v2` запущен.
    ```bash
    node server-v2/index.js
    ```
2.  В отдельном терминале выполните команду:
    ```bash
    node server-v2/folder_cycle_test.js
    ```

## 4. Full System Test (`tests/full_system_test.js`)

Полный E2E тест системы, проверяющий весь pipeline обработки кода.

### Что проверяет:
- Multi-root конфигурацию (несколько rootPath)
- Парсинг и загрузку файлов разных типов (JS, TS, PHP, SQL, DDL)
- Создание ai_items и chunk_vector
- Связи L1 в таблице link
- Извлечение колонок таблиц из SQL-функций
- Logic Architect API
- Natural Query API

### Как запустить:
```bash
node tests/full_system_test.js
```

Подробнее см. [KB/README_FULL_TEST.md](../KB/README_FULL_TEST.md)

## 5. Column Extractor Test (`tests/test_column_extractor.js`)

Тест извлечения колонок таблиц из SQL-функций.

### Что проверяет:
- Парсинг алиасов таблиц из FROM/JOIN
- Извлечение колонок из SELECT, UPDATE SET, INSERT
- Резолвинг полных имён колонок через загруженные таблицы
- Создание ai_item типа `table_column`
- Создание связей function→column с типами reads_column, updates_column, inserts_column

### Как запустить:
```bash
node tests/test_column_extractor.js
```

## Важные замечания

-   Все тесты используют `SimpleEmbeddings` и `SimpleChatModel` из ядра `packages/core`, которые являются "заглушками" и не предназначены для качественной семантической работы. Их цель — проверить работоспособность конвейера, а не качество AI-моделей.
-   Тесты спроектированы так, чтобы быть идемпотентными: `full_cycle_test.js` и `folder_cycle_test.js` сами за собой прибираются, удаляя созданные ими сущности.
-   `full_system_test.js` оставляет данные в БД для ручной проверки (context_code = FULL_TEST).
-   `test_column_extractor.js` использует отдельный context_code (COLUMN_TEST) и очищает данные после себя. 