# Спецификация системы заказов

## Общее описание

Система заказов предназначена для управления процессом оформления и обработки заказов клиентов. Она включает в себя функциональность для работы с клиентами, товарами, заказами и их позициями.

## Основные сущности

### Клиенты (customers)

Таблица `customers` хранит информацию о клиентах:
- `customer_id` - уникальный идентификатор клиента
- `name` - имя клиента
- `email` - электронная почта (уникальная)
- `phone` - номер телефона
- `created_at` - дата и время создания записи

### Товары (products)

Таблица `products` содержит информацию о доступных товарах:
- `product_id` - уникальный идентификатор товара
- `name` - название товара
- `description` - описание товара
- `price` - цена товара
- `stock_quantity` - количество товара на складе

### Заказы (orders)

Таблица `orders` хранит информацию о заказах:
- `order_id` - уникальный идентификатор заказа
- `customer_id` - идентификатор клиента
- `order_date` - дата и время создания заказа
- `status` - статус заказа (pending, processing, shipped, delivered, cancelled)
- `total_amount` - общая сумма заказа

### Позиции заказа (order_items)

Таблица `order_items` содержит информацию о товарах в заказе:
- `item_id` - уникальный идентификатор позиции
- `order_id` - идентификатор заказа
- `product_id` - идентификатор товара
- `quantity` - количество товара
- `unit_price` - цена за единицу товара
- `subtotal` - общая стоимость позиции (автоматически рассчитывается)

## Функции и процедуры

### apply_discount

Функция для применения скидки к сумме.

**Параметры:**
- `base_amount` - исходная сумма
- `discount_percent` - процент скидки

**Возвращает:** сумму со скидкой

**Ограничения:**
- Процент скидки не может быть отрицательным
- Процент скидки не может превышать 100%

### calculate_order_total

Функция для расчета общей стоимости заказа.

**Параметры:**
- `p_order_id` - идентификатор заказа
- `p_discount_percent` - процент скидки (по умолчанию 0)

**Возвращает:** общую сумму заказа с учетом скидки

**Действия:**
1. Суммирует стоимость всех позиций заказа
2. Применяет скидку, если она указана
3. Обновляет общую сумму в таблице заказов

### create_order

Процедура для создания нового заказа.

**Параметры:**
- `p_customer_id` - идентификатор клиента
- `p_items` - массив объектов JSON с информацией о товарах (product_id, quantity)

**Возвращает:** идентификатор созданного заказа

**Действия:**
1. Проверяет существование клиента
2. Создает новую запись в таблице заказов
3. Добавляет позиции заказа
4. Проверяет наличие товаров на складе
5. Уменьшает количество товаров на складе
6. Рассчитывает итоговую сумму заказа

### update_order_status

Процедура для обновления статуса заказа.

**Параметры:**
- `p_order_id` - идентификатор заказа
- `p_status` - новый статус заказа

**Возвращает:** TRUE в случае успешного обновления

**Действия:**
1. Проверяет существование заказа
2. Проверяет корректность статуса
3. Обновляет статус заказа

## Бизнес-правила

1. Клиент должен существовать в системе перед созданием заказа
2. Товары должны быть в наличии на складе в достаточном количестве
3. При создании заказа количество товаров на складе уменьшается
4. Статус заказа может принимать только предопределенные значения
5. Скидка не может быть отрицательной или превышать 100%
6. Количество товара в заказе должно быть положительным числом