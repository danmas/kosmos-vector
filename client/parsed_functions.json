[
  {
    "full_name": "carl_auct._calcAuctPriority",
    "sname": "_calcAuctPriority",
    "comment": "Рассчет приоритета аукциона\nselect carl_auct._calcAuctPriority(true,'OPEN',false,-2000);",
    "signature": "carl_auct._calcAuctPriority(p_is_vw boolean, p_auction_type en_auction_type\r\n  , p_is_total boolean, p_user_sort_prior int, p_parsed boolean)",
    "body": "create or replace function carl_auct._calcAuctPriority(p_is_vw boolean, p_auction_type en_auction_type\r\n  , p_is_total boolean, p_user_sort_prior int, p_parsed boolean)\r\n\treturns int security definer as $$\r\ndeclare\r\n  _res int := 0;\r\nbegin\r\n\r\n  if(p_is_total) then\r\n    _res := _res - 10;\r\n  end if;\r\n\r\n  -- Вагоны больше не в фаворе\r\n  --   if(p_is_vw) then\r\n  --     _res := _res + 1000;\r\n  --   end if;\r\n\r\n\t--if(p_auction_type = 'OPEN'::en_auction_type) then\r\n\tif(not p_parsed) then\r\n    _res := _res + 100;\r\n\tend if;\r\n\r\n  return _res + p_user_sort_prior;\r\nend;\r\n$$ language plpgsql;\r\n\r\n\r\n-- ----------------------------------------------------------------------------------;"
  },
  {
    "full_name": "carl_auct.calcAuctPriority",
    "sname": "calcAuctPriority",
    "comment": "Рассчет приоритета аукциона\nselect carl_auct.calcAuctPriority(2640);",
    "signature": "carl_auct.calcAuctPriority(p_id_auction int)",
    "body": "create or replace function carl_auct.calcAuctPriority(p_id_auction int)\r\n\treturns int security definer as $$\r\ndeclare\r\n  _res int := 0;\r\n\t_auction auction%rowtype;\r\n  _is_total varchar; _user_sort_prior int; _is_vw boolean; _is_parsed boolean;\r\nbegin\r\n\r\n\tselect * into _auction from auction where is_deleted = 'N' and id_auction = p_id_auction;\r\n  if(_auction.id_auction is null) then\r\n--     raise exception using message=_getMessage('AUCT_NOT_FOUND_WITH_ID') || coalesce(p_id_auction::varchar,'<NULL>')\r\n--       , errcode=_getErrcode('AUCT_NOT_FOUND_WITH_ID');\r\n    return 0;\r\n  end if;\r\n\r\n  _is_total := _getAuctObject(p_id_auction)#>>'{properties,total}';\r\n  _user_sort_prior := getAuctParameterI(p_id_auction,'{user_sort_prior}',0);\r\n  _is_vw := carl_auct.getAuctParameterB(p_id_auction,'{is_vw}', false);\r\n  _is_parsed := case when _auction.is_parsed = 'Y' then true else false end;\r\n  _res := carl_auct._calcAuctPriority(_is_vw\r\n     , _auction.auction_type\r\n     , case when _is_total is null or _is_total = 'N' then false else true end\r\n     , _user_sort_prior\r\n     , _is_parsed);\r\n\r\n  return _res;\r\nend;\r\n$$ language plpgsql;"
  },
  {
    "full_name": "carl_auct._tr_calcAuctPriority",
    "sname": "_tr_calcAuctPriority",
    "comment": "Рассчет приоритета аукциона для триггера\nselect carl_auct._tr_calcAuctPriority(100,null,'OPEN');",
    "signature": "carl_auct._tr_calcAuctPriority(p_id_auction int\r\n  , p_parameters jsonb, p_auction_type en_auction_type, p_parsed boolean)",
    "body": "create or replace function carl_auct._tr_calcAuctPriority(p_id_auction int\r\n  , p_parameters jsonb, p_auction_type en_auction_type, p_parsed boolean)\r\n\treturns int security definer as $$\r\ndeclare\r\n  _res int := 0;\r\n  _is_total varchar; _user_sort_prior int; _is_vw boolean;\r\nbegin\r\n  _is_total := coalesce((_getAuctObject(p_id_auction)#>>'{properties,total}')::varchar,'N');\r\n  _user_sort_prior := coalesce((p_parameters#>>'{user_sort_prior}')::int,0);\r\n  _is_vw := coalesce((p_parameters#>>'{is_vw}')::boolean,false);\r\n  _res := carl_auct._calcAuctPriority(_is_vw\r\n     , p_auction_type\r\n     , case when _is_total is null or _is_total = 'N' then false else true end\r\n     , _user_sort_prior\r\n     , p_parsed);\r\n  return _res;\r\nend;\r\n$$ language plpgsql;\r\n\r\n\r\n----------------------------------------------------------------------------------;"
  },
  {
    "full_name": "carl_auct._getDtEndForSort",
    "sname": "_getDtEndForSort",
    "comment": "Для сортировки аукционов в живых торгах время окончанеия берется по дате старта торгов\nselect carl_auct._getDtEndForSort(6296);",
    "signature": "carl_auct._getDtEndForSort(p_id_auction int)",
    "body": "create or replace function carl_auct._getDtEndForSort(p_id_auction int)\r\n\treturns bigint /*ERV:bigint*/ security definer as $$\r\n  select extract( epoch from case when a.id_queue is not null then q.dt_start else a.dt_end end)::bigint /*ERV:bigint*/ from auction a\r\n    left join queue q on (a.id_queue = q.id_queue)\r\n  where id_auction = p_id_auction\r\n$$ language sql;\r\n\r\n\r\n----------------------------------------------------------------------------------;"
  },
  {
    "full_name": "carl_auct._getQueSortNumForSort",
    "sname": "_getQueSortNumForSort",
    "comment": "Для сортировки аукционов в живых торгах вычисляется порядок сортировки по\norder_num\nselect carl_auct._getQueSortNumForSort(6296);",
    "signature": "carl_auct._getQueSortNumForSort(p_id_auction int)",
    "body": "create or replace function carl_auct._getQueSortNumForSort(p_id_auction int)\r\n\treturns int security definer as $$\r\n  select /*10000*queue.id_queue + */qa.order_num from queue_auction qa\r\n    where qa.id_auction = p_id_auction\r\n$$ language sql;\r\n\r\n\r\n----------------------------------------------------------------------------------;"
  }
]