# –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º AI –º–æ–¥–µ–ª–µ–π (README_AI_MODEL_integration)

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –≤–Ω–µ—à–Ω–∏–º —Å–µ—Ä–≤–µ—Ä–æ–º –ò–ò (AI Server), –∏—Å–ø–æ–ª—å–∑—É–µ–º—É—é –≤ –ø—Ä–æ–µ–∫—Ç–µ. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤, –∂–µ–ª–∞—é—â–∏—Ö –≤–Ω–µ–¥—Ä–∏—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –≤ —Å–≤–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã.

## 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –æ–±–∑–æ—Ä

–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å—Ç—Ä–æ–∏—Ç—Å—è –ø–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–π –∫–ª–∏–µ–Ω—Ç-—Å–µ—Ä–≤–µ—Ä–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ.

*   **–ö–ª–∏–µ–Ω—Ç (–í–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ):** –§–æ—Ä–º–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç (–∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π), –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç HTTP-–∑–∞–ø—Ä–æ—Å –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç.
*   **AI Server:** –í–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—â–∏–π API (–æ–±—ã—á–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å OpenAI API). –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±–ª–∞—á–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä (OpenAI, Anthropic) –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (LM Studio, Oobabooga, vLLM, LocalAI).

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ–¥—Ö–æ–¥–∞:**
*   **–£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ OpenAI API (`/v1/chat/completions`) –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ –º–µ–Ω—è—Ç—å –±—ç–∫–µ–Ω–¥ (–º–æ–¥–µ–ª–∏) –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞ –∫–ª–∏–µ–Ω—Ç–∞.
*   **–ö–æ–Ω—Ç—Ä–æ–ª—å:** –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (temperature, model) –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.
*   **–û—Ç–ª–∞–¥–∫–∞:** –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤ –≤ —Ñ–∞–π–ª –∏—Å—Ç–æ—Ä–∏–∏ (`history.json`) –ø–æ–∑–≤–æ–ª—è–µ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏.

## 2. –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

*   Node.js (v18+) –∏–ª–∏ Bun (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è).
*   –î–æ—Å—Ç—É–ø –∫ —Ä–∞–±–æ—Ç–∞—é—â–µ–º—É AI Server (URL –∏, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, API Key).

## 3. –ü–æ—à–∞–≥–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

–ù–∏–∂–µ –ø—Ä–∏–≤–µ–¥–µ–Ω –ø–æ–ª–Ω—ã–π –∫–æ–¥ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –º–æ–¥—É–ª–µ–π. –í—ã –º–æ–∂–µ—Ç–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏—Ö –≤ —Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç.

### –®–∞–≥ 1: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`env.ts`)

–í .env –¥–æ–±–∞–≤—å—Ç–µ –∫–ª—é—á
 LLM_API_KEY=<KOSMOS_MODEL_KEY>

–°–æ–∑–¥–∞–π—Ç–µ config.json
```json
{
  "LLM_BASE_URL": "http://localhost:3002/v1",
  "LLM_MODEL": "FAST",
  "LOG_LEVEL": "info",
}
```

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏. –û–Ω –¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å —á–∏—Ç–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏/–∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

```typescript
// env.ts
import { readFileSync, existsSync } from 'fs';
import { join } from 'path';

// –ü—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É
const configPath = join(process.cwd(), 'config.json');
let config: any = {};

// –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: config.json > process.env > –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
if (existsSync(configPath)) {
  try {
    config = JSON.parse(readFileSync(configPath, 'utf-8'));
  } catch (error) {
    console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è config.json, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è');
  }
}

export const LLM_BASE_URL = config.LLM_BASE_URL || process.env.LLM_BASE_URL || "http://localhost:1234/v1"; // –ü—Ä–∏–º–µ—Ä –¥–ª—è LM Studio
export const LLM_API_KEY = process.env.LLM_API_KEY || ""; 
export const LLM_MODEL = config.LLM_MODEL || process.env.LLM_MODEL || "local-model"; // –ò–º—è –º–æ–¥–µ–ª–∏
```

### –®–∞–≥ 2: –ö–ª–∏–µ–Ω—Ç API (`llm.ts`)

–≠—Ç–æ —è–¥—Ä–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏. –ú–æ–¥—É–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ—Ç–ø—Ä–∞–≤–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏.

```typescript
// llm.ts
import { LLM_BASE_URL, LLM_API_KEY, LLM_MODEL } from "./env";
import { readFileSync, writeFileSync, existsSync } from "fs";
import { join } from "path";

// === –¢–ò–ü–´ ===
export type Message = { 
    role: "system" | "user" | "assistant"; 
    content: string 
};

interface HistoryEntry {
  timestamp: string;
  model: string;
  messages: Message[];
  response: string;
  error?: string;
}

// === –õ–û–ì–ò–†–û–í–ê–ù–ò–ï (HISTORY) ===
const HISTORY_FILE = join(process.cwd(), "history.json");

function loadHistory(): HistoryEntry[] {
  if (!existsSync(HISTORY_FILE)) return [];
  try {
    return JSON.parse(readFileSync(HISTORY_FILE, "utf-8"));
  } catch {
    return [];
  }
}

function saveHistory(entry: HistoryEntry) {
  // –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å append –∏–ª–∏ –ø–æ—Ç–æ–∫–æ–≤—É—é –∑–∞–ø–∏—Å—å
  // –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ JSON –º–∞—Å—Å–∏–≤ —É–¥–æ–±–µ–Ω –¥–ª—è —á—Ç–µ–Ω–∏—è
  const history = loadHistory();
  history.push(entry);
  writeFileSync(HISTORY_FILE, JSON.stringify(history, null, 2), "utf-8");
}

// === –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ===
export async function callLLM(messages: Message[], model = LLM_MODEL): Promise<string> {
  const headers: Record<string, string> = {
    "Content-Type": "application/json",
  };
  
  if (LLM_API_KEY) {
    headers["Authorization"] = `Bearer ${LLM_API_KEY}`;
  }

  const timestamp = new Date().toISOString();
  
  try {
    console.log(`üì° –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ ${LLM_BASE_URL} (Model: ${model})...`);
    
    const res = await fetch(`${LLM_BASE_URL}/chat/completions`, {
      method: "POST",
      headers,
      body: JSON.stringify({
        model,
        messages,
        temperature: 0.3, // –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –ø–æ–¥ –∑–∞–¥–∞—á–∏ (0.1 - –∫–æ–¥, 0.7 - –∫—Ä–µ–∞—Ç–∏–≤)
        // max_tokens: 4096, // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
      }),
    });

    if (!res.ok) {
      const errorText = await res.text();
      saveHistory({ timestamp, model, messages, response: "", error: errorText });
      throw new Error(`LLM Error ${res.status}: ${errorText}`);
    }

    const json = await res.json();
    
    // –ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–≤–µ—Ç–∞ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç OpenAI)
    const response = json.choices?.[0]?.message?.content || "";
    
    if (!response) {
       throw new Error("–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –º–æ–¥–µ–ª–∏ (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ JSON –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è)");
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —É—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å
    saveHistory({ timestamp, model, messages, response });
    
    return response;

  } catch (e: any) {
    console.error("‚ùå –û—à–∏–±–∫–∞ LLM:", e.message);
    if (!e.message.startsWith("LLM Error")) {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—à–∏–±–∫–∏ —Å–µ—Ç–∏/–ø–∞—Ä—Å–∏–Ω–≥–∞
      saveHistory({ timestamp, model, messages, response: "", error: e.message });
    }
    throw e;
  }
}
```

## 4. –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

–ö–∞–∫ –≤–Ω–µ–¥—Ä–∏—Ç—å –≤—ã–∑–æ–≤ –ò–ò –≤ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É:

```typescript
import { callLLM, Message } from "./llm";

async function generateCodeTask(userGoal: string) {
    const messages: Message[] = [
        { 
            role: "system", 
            content: "–¢—ã –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–∏—Å–∞—Ç—å —á–∏—Å—Ç—ã–π –∫–æ–¥ –Ω–∞ TypeScript." 
        },
        { 
            role: "user", 
            content: `–ù–∞–ø–∏—à–∏ —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è: ${userGoal}` 
        }
    ];

    try {
        const code = await callLLM(messages);
        console.log("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥:\n", code);
    } catch (error) {
        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥.");
    }
}

// –ó–∞–ø—É—Å–∫
generateCodeTask("–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –º–∞—Å—Å–∏–≤–∞ –ø—É–∑—ã—Ä—å–∫–æ–º");
```

## 5. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ –Ω—é–∞–Ω—Å—ã

1.  **–¢–∞–π–º–∞—É—Ç—ã:** `fetch` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ –∏–º–µ–µ—Ç —Ç–∞–π–º–∞—É—Ç–∞ –≤ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö Node.js. –ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `Bun` –∏–ª–∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö Node.js –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `AbortController` –¥–ª—è –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –∑–∞–≤–∏—Å—à–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –º–æ–¥–µ–ª–µ–π –æ—Ç–≤–µ—á–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ.
2.  **–°—Ç—Ä–∏–º–∏–Ω–≥:** –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∂–¥–µ—Ç –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (`await res.json()`). –î–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Stream API (Server-Sent Events), —á—Ç–æ–±—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ –º–µ—Ä–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤.
3.  **–ö–æ–Ω—Ç–µ–∫—Å—Ç:** –°–ª–µ–¥–∏—Ç–µ –∑–∞ —Ä–∞–∑–º–µ—Ä–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (`messages`). –ï—Å–ª–∏ –º–∞—Å—Å–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π —Å—Ç–∞–Ω–µ—Ç —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–º, –º–æ–¥–µ–ª—å –≤–µ—Ä–Ω–µ—Ç –æ—à–∏–±–∫—É –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤. –†–µ–∞–ª–∏–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –æ–±—Ä–µ–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ (—Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–æ–æ–±—â–µ–Ω–∏–π –∏–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç + –ø–æ—Å–ª–µ–¥–Ω–∏–µ).
4.  **–û–±—Ä–∞–±–æ—Ç–∫–∞ JSON:** –ï—Å–ª–∏ –≤—ã –ø—Ä–æ—Å–∏—Ç–µ –º–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É—Ç—å JSON, –¥–æ–±–∞–≤—å—Ç–µ –≤ `callLLM` –≤–∞–ª–∏–¥–∞—Ü–∏—é –æ—Ç–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ `try-catch JSON.parse()`, —Ç–∞–∫ –∫–∞–∫ –º–æ–¥–µ–ª–∏ –∏–Ω–æ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è—é—Ç –ª–∏—à–Ω–∏–π —Ç–µ–∫—Å—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä "–í–æ—Ç –≤–∞—à JSON: ...").

## 6. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ `history.json`

–§–∞–π–ª –∏—Å—Ç–æ—Ä–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:

```json
[
  {
    "timestamp": "2023-10-27T10:00:00.000Z",
    "model": "gpt-4-local",
    "messages": [...],
    "response": "function bubbleSort() { ... }",
    "error": null
  }
]
```

