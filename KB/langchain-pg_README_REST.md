# REST API документация для LangChain RAG с PostgreSQL

## Обзор API

Данный модуль предоставляет REST API для работы с LangChain RAG (Retrieval Augmented Generation) системой, использующей PostgreSQL с расширением pgvector для хранения векторных эмбеддингов. API позволяет задавать вопросы по загруженным документам, управлять документами и их контекстами, а также просматривать их чанки.

## Базовый URL

```
http://localhost:3000
```

## Конечные точки API

### Ответ на вопросы

#### Запрос вопроса

```
POST /ask
```

Отправляет вопрос к RAG-системе и получает ответ на основе загруженных документов.

##### Параметры запроса (JSON)

| Параметр      | Тип     | Обязательный | Описание                                                   |
|---------------|---------|--------------|-----------------------------------------------------------|
| question      | string  | Да           | Вопрос пользователя                                        |
| contextCode   | string  | Нет          | Код контекста для фильтрации документов (null - все документы) |
| showDetails   | boolean | Нет          | Флаг для включения деталей обработки в ответ               |

##### Пример запроса

```json
{
  "question": "Что такое нейронные сети?",
  "contextCode": "AI",
  "showDetails": true
}
```

##### Пример ответа

```json
{
  "answer": "Нейронные сети - это вычислительные системы, вдохновленные биологическими нейронными сетями. Глубокое обучение использует многослойные нейронные сети для обработки данных.",
  "source": "postgres",
  "contextCode": "AI",
  "documents": [
    {
      "pageContent": "Нейронные сети - это вычислительные системы, вдохновленные биологическими нейронными сетями. Глубокое обучение использует многослойные нейронные сети для обработки данных.",
      "metadata": {
        "filename": "document2.txt",
        "source": "/root/projects/langchain-pg/docs/document2.txt",
        "chunkIndex": 0,
        "contextCode": "AI"
      }
    }
  ],
  "prompt": "Используй следующие фрагменты контекста для ответа на вопрос в конце. \nЕсли ты не знаешь ответа, просто скажи, что не знаешь, не пытайся придумать ответ.\n\nНейронные сети - это вычислительные системы, вдохновленные биологическими нейронными сетями. Глубокое обучение использует многослойные нейронные сети для обработки данных.\n\nВопрос: Что такое нейронные сети?\nОтвет:"
}
```

##### Коды ответа

| Код | Описание                                 |
|-----|------------------------------------------|
| 200 | Успешный ответ                           |
| 400 | Ошибка запроса (например, отсутствует вопрос) |
| 500 | Внутренняя ошибка сервера                |

### Управление документами

#### Получение списка документов

```
GET /documents
```

Получает список всех документов, доступных в системе.

##### Пример ответа

```json
[
  {
    "name": "document1.txt",
    "type": "Текст",
    "size": 250,
    "modified": "2023-10-15 14:23:45",
    "vectorized": true,
    "needsUpdate": false,
    "contextCode": "HISTORY",
    "chunksCount": 2
  },
  {
    "name": "document2.txt",
    "type": "Текст",
    "size": 180,
    "modified": "2023-10-16 09:12:30",
    "vectorized": true,
    "needsUpdate": false,
    "contextCode": "AI",
    "chunksCount": 1
  }
]
```

##### Коды ответа

| Код | Описание                 |
|-----|--------------------------|
| 200 | Успешный ответ           |
| 500 | Внутренняя ошибка сервера |

#### Векторизация файла

```
POST /vectorize/:filename
```

Векторизует указанный файл и сохраняет его эмбеддинги в базе данных.

##### Параметры URL

| Параметр  | Описание                |
|-----------|-------------------------|
| filename  | Имя файла для векторизации |

##### Параметры запроса (JSON)

| Параметр    | Тип    | Обязательный | Описание                   |
|-------------|--------|--------------|----------------------------|
| contextCode | string | Нет          | Код контекста для файла    |

##### Пример запроса

```json
{
  "contextCode": "AI"
}
```

##### Пример ответа

```json
{
  "success": true,
  "message": "Файл document3.txt успешно векторизован и сохранен в БД",
  "isNew": true,
  "chunksCount": 3
}
```

##### Коды ответа

| Код | Описание                                 |
|-----|------------------------------------------|
| 200 | Успешный ответ                           |
| 404 | Файл не найден                           |
| 500 | Внутренняя ошибка сервера                |

### Управление контекстами

#### Получение списка контекстных кодов

```
GET /context-codes
```

Получает список всех уникальных контекстных кодов, используемых в системе.

##### Пример ответа

```json
["AI", "HISTORY", "NLP", "UNKNOWN"]
```

##### Коды ответа

| Код | Описание                 |
|-----|--------------------------|
| 200 | Успешный ответ           |
| 500 | Внутренняя ошибка сервера |

#### Обновление контекстного кода файла

```
POST /update-context/:filename
```

Обновляет контекстный код для указанного файла.

##### Параметры URL

| Параметр  | Описание                         |
|-----------|----------------------------------|
| filename  | Имя файла для обновления контекста |

##### Параметры запроса (JSON)

| Параметр    | Тип    | Обязательный | Описание                   |
|-------------|--------|--------------|----------------------------|
| contextCode | string | Да           | Новый код контекста для файла |

##### Пример запроса

```json
{
  "contextCode": "NLP"
}
```

##### Пример ответа

```json
{
  "success": true,
  "message": "Контекстный код для файла document3.txt обновлен на NLP",
  "previousContextCode": "UNKNOWN"
}
```

##### Коды ответа

| Код | Описание                                 |
|-----|------------------------------------------|
| 200 | Успешный ответ                           |
| 400 | Ошибка запроса (контекстный код не указан) |
| 404 | Файл не найден                           |
| 500 | Внутренняя ошибка сервера                |

### Просмотр чанков документов

#### Получение чанков файла

```
GET /file-chunks/:filename
```

Получает список всех чанков для указанного файла.

##### Параметры URL

| Параметр  | Описание                   |
|-----------|----------------------------|
| filename  | Имя файла для получения чанков |

##### Пример ответа

```json
{
  "success": true,
  "filename": "document2.txt",
  "contextCode": "AI",
  "chunks": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "chunk_content": "Нейронные сети - это вычислительные системы, вдохновленные биологическими нейронными сетями. Глубокое обучение использует многослойные нейронные сети для обработки данных.",
      "chunk_index": 0
    }
  ],
  "fileInfo": {
    "modified_at": "2023-10-16T09:12:30.000Z",
    "created_at": "2023-10-16T09:12:30.000Z",
    "chunks_count": 1
  }
}
```

##### Коды ответа

| Код | Описание                 |
|-----|--------------------------|
| 200 | Успешный ответ           |
| 404 | Файл не найден           |
| 500 | Внутренняя ошибка сервера |

## Статические файлы

Сервер также предоставляет доступ к статическим файлам из директории `public`:

```
GET /
```

Возвращает главную HTML-страницу приложения.

```
GET /styles.css
```

Возвращает CSS-стили для приложения.

```
GET /index.js
```

Возвращает JavaScript-код для клиентской части приложения.

## Примечания по использованию

1. Для работы API требуется подключение к PostgreSQL с расширением pgvector.
2. API поддерживает контекстную фильтрацию, позволяющую ограничить поиск документов определенным контекстом.
3. Векторизация файлов выполняется с использованием OpenAI API для создания эмбеддингов.
4. Система автоматически отслеживает изменения в файлах и повторно векторизует их только при необходимости.
