# Миграция UI: Переход с l1_deps на l1_in + l1_out

## Обзор изменений

API теперь возвращает связи L1 в новом формате:
- **Было**: `l1_deps: string[]` — массив зависимостей
- **Стало**: `l1_in: string[]` + `l1_out: string[]` — разделение по направлению

---

## Изменения в API ответах

### Схема AiItem

| Поле | Тип | Описание |
|------|-----|----------|
| `l1_in` | `string[]` | Входящие связи: кто вызывает/использует этот элемент |
| `l1_out` | `string[]` | Исходящие связи: что вызывает/использует этот элемент |

### Пример ответа `/api/items/:id`

```json
{
  "id": "carl_auct.calcPriority",
  "type": "function",
  "language": "sql",
  "l0_code": "CREATE FUNCTION...",
  "l1_in": ["carl_auct.processAuction", "carl_auct.runBatch"],
  "l1_out": ["carl_auct.auction", "carl_auct._getAuctObject"],
  "l2_desc": "Вычисляет приоритет аукциона",
  "filePath": "./sql/functions.sql"
}
```

---

## Как использовать в UI

### 1. l1_out — Исходящие связи

**Семантика**: Элемент вызывает/читает/использует другие элементы

**Рекомендации по отображению**:
- **Иконка**: стрелка вправо → или иконка "зависимости"
- **Подсказка**: "Этот элемент вызывает/читает/использует"
- **Цвет**: обычно синий или нейтральный
- **Группировка**: можно показать как "Зависимости" или "Использует"

**Пример использования**:
```typescript
// Показать список зависимостей элемента
{item.l1_out.map(dep => (
  <Link key={dep} to={`/items/${dep}`}>
    → {dep}
  </Link>
))}
```

### 2. l1_in — Входящие связи

**Семантика**: Элемент вызывается/используется другими элементами

**Рекомендации по отображению**:
- **Иконка**: стрелка влево ← или иконка "используется в"
- **Подсказка**: "Этот элемент вызывается/используется в"
- **Цвет**: обычно зелёный или другой отличный от l1_out
- **Группировка**: можно показать как "Используется в" или "Вызывается из"

**Пример использования**:
```typescript
// Показать список элементов, использующих текущий
{item.l1_in.map(source => (
  <Link key={source} to={`/items/${source}`}>
    ← {source}
  </Link>
))}
```

### 3. Граф зависимостей (`/api/graph`)

**Изменения**:
- Формат ответа не меняется (nodes + links)
- Связи теперь строятся на основе `l1_out` вместо `l1_deps`
- Label связи пока упрощён до "depends on" (детализация типов связей — в будущем)

**Пример ответа**:
```json
{
  "nodes": [
    { "id": "func1", "type": "function", ... },
    { "id": "func2", "type": "function", ... }
  ],
  "links": [
    { "source": "func1", "target": "func2", "label": "depends on" }
  ]
}
```

---

## Миграция кода

### Шаг 1: Заменить все обращения к `l1_deps`

**Было**:
```typescript
const dependencies = item.l1_deps || [];
```

**Стало**:
```typescript
const dependencies = item.l1_out || [];
```

### Шаг 2: Добавить отображение входящих связей

**Новый код**:
```typescript
// Исходящие связи (зависимости)
{item.l1_out && item.l1_out.length > 0 && (
  <section>
    <h3>Зависимости (→)</h3>
    {item.l1_out.map(dep => (
      <Link key={dep} to={`/items/${dep}`}>{dep}</Link>
    ))}
  </section>
)}

// Входящие связи (используется в)
{item.l1_in && item.l1_in.length > 0 && (
  <section>
    <h3>Используется в (←)</h3>
    {item.l1_in.map(source => (
      <Link key={source} to={`/items/${source}`}>{source}</Link>
    ))}
  </section>
)}
```

### Шаг 3: Обновить TypeScript типы

**Было**:
```typescript
interface AiItem {
  id: string;
  l1_deps: string[];
  // ...
}
```

**Стало**:
```typescript
interface AiItem {
  id: string;
  l1_in: string[];
  l1_out: string[];
  // ...
}
```

---

## Затронутые эндпоинты

| Эндпоинт | Изменения |
|----------|-----------|
| `GET /api/items` | Возвращает `l1_in` и `l1_out` вместо `l1_deps` |
| `GET /api/items/:id` | Возвращает `l1_in` и `l1_out` вместо `l1_deps` |
| `GET /api/graph` | Использует `l1_out` для построения графа |

---

## Обратная совместимость

⚠️ **Внимание**: Поле `l1_deps` больше не существует в API ответах.

Если ваш код обращается к `item.l1_deps`, он получит `undefined`. Обязательно обновите все места использования.

---

## Примеры визуализации

### Карточка элемента

```
┌─────────────────────────────────┐
│ carl_auct.calcPriority          │
│ [function] SQL                   │
├─────────────────────────────────┤
│ Зависимости (→):                │
│   → carl_auct.auction           │
│   → carl_auct._getAuctObject    │
├─────────────────────────────────┤
│ Используется в (←):             │
│   ← carl_auct.processAuction    │
│   ← carl_auct.runBatch          │
└─────────────────────────────────┘
```

### Граф зависимостей

```
func1 ──→ func2
  ↑         │
  │         ↓
func3 ←── func4
```

---

## Дополнительные рекомендации

1. **Пустые массивы**: Оба поля всегда присутствуют в ответе (могут быть пустыми массивами `[]`)

2. **Производительность**: Для больших списков используйте виртуализацию или пагинацию

3. **Фильтрация**: Можно добавить фильтры для показа только входящих или только исходящих связей

4. **Поиск**: Реализуйте поиск по `l1_in` и `l1_out` для быстрого нахождения зависимостей

5. **Визуализация**: Используйте разные цвета/иконки для `l1_in` и `l1_out` для лучшей читаемости

---

## Вопросы и поддержка

При возникновении проблем с миграцией обращайтесь к команде разработки API.

Последнее обновление: 2026-01-22
